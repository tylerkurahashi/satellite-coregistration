# SpaceNet9 ベースライン学習・評価計画

## 概要
SpaceNet9チャレンジのベースライン手法を再現し、光学画像とSAR画像間のクロスモーダル位置合わせ（コレジストレーション）を実現する。キーポイント検出ベースのアプローチを採用し、深層学習モデルによる対応点推定を行う。

## 目的
- キーポイント検出モデルの実装と学習
- 光学画像とSAR画像間の対応点マッチング
- 変換行列（ホモグラフィー等）の推定
- SpaceNet9の評価指標での性能測定

## ディレクトリ構造

```
project/spacenet9/02_traineval/
├── plan/                   # 学習・評価要件定義ドキュメント
├── models/                 # モデル実装
├── scripts/               # 学習・評価スクリプト
├── configs/               # 学習設定ファイル
├── checkpoints/           # 学習済みモデル
├── results/               # 評価結果
└── notebooks/             # 実験・可視化ノートブック
```

## 技術スタック
- PyTorch（深層学習フレームワーク）
- Segmentation models pytorch (SMP)
- torchvision（画像処理）
- OpenCV（画像変換・キーポイント処理）
- scikit-learn（評価指標）
- wandb/tensorboard（実験管理）

## TODO リスト

### 1. データローダーの実装
- [ ] SpaceNet9データセット用のPyTorch Datasetクラスを実装
   - [ ] 光学画像タイルの読み込み機能
   - [ ] SAR画像タイルの読み込み機能
   - [ ] ガウシアンヒートマップ（ラベル）の読み込み機能
   - [ ] データ拡張（回転、フリップ、輝度調整等）の実装
- [ ] train/val/testデータ分割の実装
- [ ] バッチサンプリングの最適化

### 2. モデルアーキテクチャの実装
- [ ] ベースラインモデル（U-Net）の実装
   - [ ] エンコーダー部分の実装（ResNet/EfficientNetバックボーン）
   - [ ] デコーダー部分の実装（アップサンプリング + スキップ接続）
   - [ ] ヒートマップ出力層の実装
- [ ] 損失関数の実装
   - [ ] MSE損失（ヒートマップ回帰）
   - [ ] Focal損失（クラス不均衡対応）
   - [ ] 複合損失関数の実装
- [ ] キーポイント抽出後処理の実装
   - [ ] ヒートマップからのピーク検出
   - [ ] サブピクセル精度での座標推定

### 3. 学習スクリプトの作成
- [ ] 学習ループの実装
   - [ ] モデル初期化
   - [ ] オプティマイザー設定（Adam/SGD）
   - [ ] 学習率スケジューラー実装
   - [ ] チェックポイント保存機能
- [ ] 検証ループの実装
   - [ ] 検証データでの性能評価
   - [ ] Early Stopping実装
- [ ] 実験管理システムの統合
   - [ ] wandb/tensorboardへのログ記録
   - [ ] ハイパーパラメータ管理

### 4. 評価・推論スクリプトの作成
- [ ] キーポイントマッチングの実装
   - [ ] 光学→SAR方向のキーポイント検出
   - [ ] SAR→光学方向のキーポイント検出
   - [ ] 双方向マッチングによる対応点ペア生成
- [ ] 変換行列推定の実装
   - [ ] RANSAC付きホモグラフィー推定
   - [ ] アフィン変換推定
   - [ ] TPS（Thin Plate Spline）変換の実装
- [ ] 評価指標の実装
   - [ ] 平均ピクセル誤差（MAE）
   - [ ] RMSE（Root Mean Square Error）
   - [ ] 成功率（閾値以内の予測割合）

### 5. ベースライン再現実験
- [ ] 学習設定ファイルの作成
   - [ ] ハイパーパラメータ設定
   - [ ] データ拡張設定
   - [ ] 学習スケジュール設定
- [ ] ベースラインモデルの学習
   - [ ] 各地域（001, 002, 003）での交差検証
   - [ ] 最適ハイパーパラメータの探索
- [ ] 結果の可視化と分析
   - [ ] 予測キーポイントの可視化
   - [ ] 変換結果の重ね合わせ表示
   - [ ] エラー分析（失敗ケースの調査）

### 6. 高度な手法の実装（オプション）
- [ ] マルチスケールキーポイント検出
   - [ ] Feature Pyramid Network (FPN)の統合
   - [ ] マルチ解像度での推論
- [ ] 自己教師あり学習の導入
   - [ ] コントラスト学習による特徴表現学習
   - [ ] 擬似ラベルを用いた半教師あり学習
- [ ] ドメイン適応手法
   - [ ] 光学-SAR間のドメインギャップ削減
   - [ ] Adversarial trainingの導入

### 7. テストスクリプトの作成
- [ ] 単体テストの実装
   - [ ] データローダーのテスト
   - [ ] モデル順伝播のテスト
   - [ ] 評価指標計算のテスト
- [ ] 統合テストの実装
   - [ ] End-to-endパイプラインのテスト
   - [ ] 性能ベンチマークテスト

## 評価基準
- **主要指標**: タイポイントでの平均ピクセル誤差
- **副次指標**: 
  - 10ピクセル以内の精度達成率
  - 処理速度（FPS）
  - モデルサイズとメモリ使用量

## 実装優先順位
1. 基本的なデータローダーとU-Netモデル
2. 学習・評価スクリプト
3. ベースライン再現
4. 結果の可視化
5. 高度な手法の実装

## 参考文献
- SpaceNet 9 Challenge公式ドキュメント
- U-Net: Convolutional Networks for Biomedical Image Segmentation
- SuperPoint: Self-Supervised Interest Point Detection and Description
- D2-Net: A Trainable CNN for Joint Description and Detection of Local Features